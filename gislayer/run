#!/bin/bash
set -e

dbhost=${HDX_GISDB_ADDR}
dbport=${HDX_GISDB_PORT}

# make sure postgis extension are enabled on psql
[ "$(psql -h $dbhost -p $dbport gis gis -c '\dx' | grep -c  postgis\ )" -eq "1" ] || psql -h $dbhost -p $dbport gis gis -c 'CREATE EXTENSION postgis;'
# make sure postgis_topology extension are enabled on psql
[ "$(psql -h $dbhost -p $dbport gis gis -c '\dx' | grep -c  postgis_topology)" -eq "1" ] || psql -h $dbhost -p $dbport gis gis -c 'CREATE EXTENSION postgis_topology;'

# make sure pgpass is up to date
[ -f /root/.pgpass ] || envsubst < /root/.pgpass.tpl > /root/.pgpass
[ $(cat /root/.pgpass | grep -c "${dbhost}:${dbport}:\*:gis:gis") -eq 1 ] || envsubst < /root/.pgpass.tpl > /root/.pgpass

# regenerate app.conf
envsubst < /srv/app.conf.tpl > /srv/app.conf

cd /srv/gislayer
export GIS_REST_LAYER_CONF=/srv/app.conf

exec python gis_rest_layer.py
